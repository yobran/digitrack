generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  role      UserRole @default(intern)
  phone     String?
  countyId  String?
  county    County?  @relation(fields: [countyId], references: [id])
  
  // Relationships
  assignedSchools SchoolAssignment[]
  visits          Visit[]
  reportedIssues  Issue[] @relation("ReportedIssues")
  assignedIssues  Issue[] @relation("AssignedIssues")
  comments        Comment[]
  schools         School[] // ADD THIS LINE
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model County {
  id          String      @id @default(cuid())
  name        String      @unique
  code        String      @unique
  subCounties SubCounty[]
  schools     School[]
  users       User[]
  
  createdAt DateTime @default(now())
}

model SubCounty {
  id       String   @id @default(cuid())
  name     String
  code     String
  countyId String
  county   County  @relation(fields: [countyId], references: [id])
  schools  School[]
  
  createdAt DateTime @default(now())
}

model School {
  id               String   @id @default(cuid())
  name             String
  code             String   @unique
  location         String
  latitude         Float?
  longitude        Float?
  headteacherName  String
  headteacherPhone String
  hasElectricity   Boolean  @default(false)
  hasInternet      Boolean  @default(false)
  totalStudents    Int      @default(0)
  
  // Relationships
  subCountyId String
  subCounty   SubCounty @relation(fields: [subCountyId], references: [id])
  countyId    String?
  county      County?   @relation(fields: [countyId], references: [id])
  userId      String?   // assigned intern
  user        User?     @relation(fields: [userId], references: [id])
  
  assignments SchoolAssignment[]
  devices     Device[]
  visits      Visit[]
  teachers    Teacher[]
  issues      Issue[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SchoolAssignment {
  id       String @id @default(cuid())
  userId   String
  schoolId String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())
  
  @@unique([userId, schoolId])
}

model Device {
  id           String   @id @default(cuid())
  schoolId     String
  deviceType   DeviceType
  serialNumber String
  brand        String?
  model        String?
  status       DeviceStatus @default(working)
  conditionNotes String?
  purchaseDate DateTime?
  
  // Relationships
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  history  DeviceHistory[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DeviceHistory {
  id          String   @id @default(cuid())
  deviceId    String
  device      Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  status      DeviceStatus
  notes       String?
  recordedBy  String? // User ID
  recordedAt  DateTime @default(now())
}

model Visit {
  id            String   @id @default(cuid())
  userId        String
  schoolId      String
  visitDate     DateTime @default(now())
  devicesChecked Int?
  issuesFound   String?
  actionsTaken  String?
  photos        String? // JSON string of photo URLs
  gpsLatitude   Float?
  gpsLongitude  Float?
  durationMinutes Int?
  
  // Relationships
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
}

model Teacher {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  email     String?
  schoolId  String
  school    School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  trainingRecords TeacherTraining[]
  
  createdAt DateTime @default(now())
}

model TeacherTraining {
  id          String   @id @default(cuid())
  teacherId   String
  teacher     Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  module      TrainingModule
  skillLevel  SkillLevel @default(beginner)
  completedAt DateTime?
  notes       String?
  
  createdAt DateTime @default(now())
}

model Issue {
  id          String      @id @default(cuid())
  title       String
  description String
  category    IssueCategory
  priority    Priority    @default(medium)
  status      IssueStatus @default(open)
  schoolId    String
  school      School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  reportedById String?
  reportedBy  User?      @relation("ReportedIssues", fields: [reportedById], references: [id])
  assignedToId String?
  assignedTo  User?      @relation("AssignedIssues", fields: [assignedToId], references: [id])
  
  comments    Comment[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Comment {
  id      String   @id @default(cuid())
  issueId String
  issue   Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  userId  String
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content String
  createdAt DateTime @default(now())
}

// Enums
enum UserRole {
  intern
  county_admin
  national_admin
}

enum DeviceType {
  tablet
  laptop
  projector
  router
  printer
  other
}

enum DeviceStatus {
  working
  needs_repair
  stolen
  under_maintenance
  decommissioned
}

enum TrainingModule {
  basic_computer_skills
  device_startup_charging
  accessing_cbc_content
  troubleshooting
  classroom_management
}

enum SkillLevel {
  beginner
  intermediate
  advanced
}

enum IssueCategory {
  device_broken
  power_connectivity
  training_assistance
  content_missing
  other
}

enum Priority {
  low
  medium
  high
  critical
}

enum IssueStatus {
  open
  in_progress
  resolved
  closed
}